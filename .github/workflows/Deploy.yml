name: Deploy

# ì´ ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ ì„¤ì •
on:
  push:
    branches: [ "dev" ]    # develop ë¸Œëœì¹˜ push ì‹œ ì‹¤í–‰
  pull_request:
    branches: [ "dev" ]    # develop ëŒ€ìƒ PR ìƒì„± ì‹œ ì‹¤í–‰

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. GitHub ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout
        uses: actions/checkout@v4

      # 2. JDK 17 ì„¸íŒ…
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Spring Boot ì‹¤í–‰ì— í•„ìš”í•œ env.properties íŒŒì¼ ìƒì„±
      - name: Create env.properties
        run: |
          mkdir -p ./src/main/resources
          cd ./src/main/resources
          touch env.properties
          echo "${{ secrets.ENV }}" > env.properties
        shell: bash

      # 4. gradlew ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 5. Gradle build (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Build with Gradle
        uses: gradle/gradle-build-action@v3
        with:
          arguments: clean build -x test

      # 6. Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 7. Docker ì´ë¯¸ì§€ ë¹Œë“œ í›„ Docker Hubì— í‘¸ì‹œ
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./src/Dockerfile           # ë„¤ Dockerfile ê²½ë¡œ
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPO }}:latest

      # 8. EC2 SSH ì ‘ì† í›„ Docker ì´ë¯¸ì§€ pull & ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "ğŸ”¹ Docker Hub ë¡œê·¸ì¸"
            sudo docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

            echo "ğŸ”¹ ìµœì‹  ì´ë¯¸ì§€ pull"
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPO }}:latest

            echo "ğŸ”¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë° ì‚­ì œ"
            sudo docker stop livenote || true
            sudo docker rm livenote || true

            echo "ğŸ”¹ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            sudo docker run -d \
              --name livenote \
              -p 8080:8080 \
              ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPO }}:latest

            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
